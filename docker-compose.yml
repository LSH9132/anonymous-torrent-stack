version: "3.8"

services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "${QBITTORRENT_PORT:-127.0.0.1:8080}:8080"  # qBittorrent WebUI
      - "${GLUETUN_CONTROL_PORT:-127.0.0.1:8000}:8000"  # Gluetun control server
    environment:
      # Core VPN Settings
      - VPN_SERVICE_PROVIDER=${VPN_PROVIDER:-custom}
      - VPN_TYPE=${VPN_TYPE:-wireguard}

      # Server Selection
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-}
      - SERVER_CITIES=${SERVER_CITIES:-}
      - SERVER_HOSTNAMES=${SERVER_HOSTNAMES:-}

      # WireGuard Settings (when VPN_TYPE=wireguard)
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY:-}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES:-}
      - WIREGUARD_PUBLIC_KEY=${WIREGUARD_PUBLIC_KEY:-}
      - WIREGUARD_ENDPOINT_IP=${WIREGUARD_ENDPOINT_IP:-}
      - WIREGUARD_ENDPOINT_PORT=${WIREGUARD_ENDPOINT_PORT:-51820}

      # OpenVPN Settings (when VPN_TYPE=openvpn)
      - OPENVPN_USER=${OPENVPN_USER:-}
      - OPENVPN_PASSWORD=${OPENVPN_PASSWORD:-}
      - OPENVPN_CUSTOM_CONFIG=${OPENVPN_CUSTOM_CONFIG:-}

      # DNS over TLS (prevents DNS leaks)
      - DOT=${DOT:-on}
      - DOT_PROVIDERS=${DOT_PROVIDERS:-cloudflare}
      - DOT_CACHING=${DOT_CACHING:-on}
      - DOT_IPV6=${DOT_IPV6:-off}
      - BLOCK_MALICIOUS=${BLOCK_MALICIOUS:-on}
      - BLOCK_SURVEILLANCE=${BLOCK_SURVEILLANCE:-off}
      - BLOCK_ADS=${BLOCK_ADS:-off}

      # Firewall (kill switch implementation)
      - FIREWALL=${FIREWALL:-on}
      - FIREWALL_VPN_INPUT_PORTS=${FIREWALL_VPN_INPUT_PORTS:-}
      - FIREWALL_INPUT_PORTS=${FIREWALL_INPUT_PORTS:-}
      - FIREWALL_OUTBOUND_SUBNETS=${FIREWALL_OUTBOUND_SUBNETS:-}
      - FIREWALL_DEBUG=${FIREWALL_DEBUG:-off}

      # Health Check Configuration
      - HEALTH_VPN_DURATION_INITIAL=${HEALTH_VPN_DURATION_INITIAL:-30s}
      - HEALTH_VPN_DURATION_ADDITION=${HEALTH_VPN_DURATION_ADDITION:-5s}
      - HEALTH_TARGET_ADDRESS=${HEALTH_TARGET_ADDRESS:-cloudflare.com:443}
      - HEALTH_SUCCESS_WAIT_DURATION=${HEALTH_SUCCESS_WAIT_DURATION:-5s}

      # Port Forwarding (for supported providers: PIA, ProtonVPN, etc.)
      - VPN_PORT_FORWARDING=${VPN_PORT_FORWARDING:-off}
      - VPN_PORT_FORWARDING_PROVIDER=${VPN_PORT_FORWARDING_PROVIDER:-}

      # Timezone
      - TZ=${TZ:-UTC}

      # HTTP Control Server
      - HTTP_CONTROL_SERVER_LOG=${HTTP_CONTROL_SERVER_LOG:-on}
      - HTTP_CONTROL_SERVER_ADDRESS=${HTTP_CONTROL_SERVER_ADDRESS:-:8000}

      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}

      # Optional: Proxy servers (disabled by default)
      - HTTPPROXY=${HTTPPROXY:-off}
      - SHADOWSOCKS=${SHADOWSOCKS:-off}

    volumes:
      - ./config/gluetun:/gluetun
      - ./config/vpn/wireguard:/gluetun/wireguard:ro
      - ./config/vpn/openvpn:/gluetun/custom:ro
    restart: unless-stopped
    networks:
      - vpn_network
    healthcheck:
      test: ["CMD", "/gluetun-entrypoint", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  qbittorrent:
    image: lscr.io/linuxserver/qbittorrent:latest
    container_name: qbittorrent
    # Network mode: ALL traffic goes through Gluetun (primary kill switch)
    network_mode: "service:gluetun"
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-UTC}
      - WEBUI_PORT=8080
      - TORRENTING_PORT=${TORRENTING_PORT:-6881}
    volumes:
      - ./config/qbittorrent:/config
      - ./data/downloads:/downloads
    restart: unless-stopped
    depends_on:
      gluetun:
        condition: service_healthy

networks:
  vpn_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
