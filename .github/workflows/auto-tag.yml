name: Auto Tag

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to tag (e.g., 1.0.0)'
        required: true
        type: string
      release_type:
        description: 'Type of release'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  create-tag:
    name: Create Version Tag
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get current version
        id: current
        run: |
          # ê°€ì¥ ìµœê·¼ íƒœê·¸ ê°€ì ¸ì˜¤ê¸°
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Current version: $LATEST_TAG"

      - name: Calculate new version
        id: new_version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            # ìˆ˜ë™ìœ¼ë¡œ ë²„ì „ ì…ë ¥í•œ ê²½ìš°
            NEW_VERSION="${{ github.event.inputs.version }}"
          else
            # í˜„ì¬ ë²„ì „ì—ì„œ ìë™ ì¦ê°€
            LATEST="${{ steps.current.outputs.latest_tag }}"
            LATEST=${LATEST#v}  # v ì œê±°

            IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST"

            case "${{ github.event.inputs.release_type }}" in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: v$NEW_VERSION"

      - name: Update CHANGELOG
        run: |
          VERSION="${{ steps.new_version.outputs.new_version }}"
          DATE=$(date +%Y-%m-%d)

          # CHANGELOG.mdì˜ [Unreleased] ì„¹ì…˜ì„ ìƒˆ ë²„ì „ìœ¼ë¡œ ë³€ê²½
          sed -i.bak "s/## \[Unreleased\]/## [Unreleased]\n\n## [$VERSION] - $DATE/" CHANGELOG.md

          # ë¹„êµ ë§í¬ ì—…ë°ì´íŠ¸
          PREV_VERSION="${{ steps.current.outputs.latest_tag }}"
          PREV_VERSION=${PREV_VERSION#v}

          # ìƒˆ ë²„ì „ ë¹„êµ ë§í¬ ì¶”ê°€
          echo "[Unreleased]: https://github.com/${{ github.repository }}/compare/v$VERSION...HEAD" >> CHANGELOG.md.tmp
          echo "[$VERSION]: https://github.com/${{ github.repository }}/compare/v$PREV_VERSION...v$VERSION" >> CHANGELOG.md.tmp

          # ê¸°ì¡´ ë§í¬ ì œê±°í•˜ê³  ìƒˆ ë§í¬ ì¶”ê°€
          grep -v "^\[" CHANGELOG.md | head -n -1 > CHANGELOG.md.new
          cat CHANGELOG.md.tmp >> CHANGELOG.md.new
          mv CHANGELOG.md.new CHANGELOG.md
          rm CHANGELOG.md.tmp CHANGELOG.md.bak

          cat CHANGELOG.md

      - name: Commit changes
        run: |
          VERSION="${{ steps.new_version.outputs.new_version }}"

          git add CHANGELOG.md
          git commit -m "chore: release v$VERSION

          - Update CHANGELOG for v$VERSION
          - Automated version bump

          ğŸ¤– Generated by GitHub Actions" || echo "No changes to commit"

          git push origin main

      - name: Create and push tag
        run: |
          VERSION="${{ steps.new_version.outputs.new_version }}"

          git tag -a "v$VERSION" -m "Release v$VERSION

          See CHANGELOG.md for details.

          ğŸ¤– Generated by GitHub Actions"

          git push origin "v$VERSION"

          echo "âœ… Created and pushed tag: v$VERSION"

      - name: Summary
        run: |
          VERSION="${{ steps.new_version.outputs.new_version }}"

          echo "## Release v$VERSION Created! ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Previous**: ${{ steps.current.outputs.latest_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The release workflow will be triggered automatically." >> $GITHUB_STEP_SUMMARY
