name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: |
          docker compose config > /dev/null
          echo "✅ Docker Compose configuration is valid"

      - name: Validate .env.example
        run: |
          # .env.example 파일이 필수 변수를 포함하는지 확인
          required_vars=(
            "VPN_PROVIDER"
            "VPN_TYPE"
            "QBITTORRENT_PORT"
            "GLUETUN_CONTROL_PORT"
          )

          for var in "${required_vars[@]}"; do
            if ! grep -q "^${var}=" .env.example; then
              echo "❌ Missing required variable: $var"
              exit 1
            fi
          done

          echo "✅ .env.example contains all required variables"

      - name: Validate scripts
        run: |
          # 스크립트 파일이 실행 가능한지 확인
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              if [ ! -x "$script" ]; then
                echo "❌ Script not executable: $script"
                exit 1
              fi
              echo "✅ $script is executable"
            fi
          done

      - name: Check for broken links in markdown
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'

  shellcheck:
    name: ShellCheck Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning

  yaml-lint:
    name: Lint YAML Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            docker-compose.yml
            .github/workflows/
          config_file: .github/yamllint-config.yml
          strict: false

  test-setup:
    name: Test Setup Script
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test directory creation
        run: |
          # setup.sh의 디렉토리 생성 부분만 테스트
          mkdir -p config/{gluetun,qbittorrent,vpn/{wireguard,openvpn}}
          mkdir -p data/{qbittorrent,downloads}
          mkdir -p docs/vpn-providers
          mkdir -p scripts

          echo "✅ All directories created successfully"

      - name: Test .env creation
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
            echo "✅ .env file created from template"
          else
            echo "❌ .env.example not found"
            exit 1
          fi

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required documentation
        run: |
          required_docs=(
            "README.md"
            "README.ko.md"
            "CONTRIBUTING.md"
            "CHANGELOG.md"
            "LICENSE"
            "docs/setup-guide.md"
            "docs/troubleshooting.md"
            "docs/advanced-configuration.md"
          )

          for doc in "${required_docs[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "❌ Missing required documentation: $doc"
              exit 1
            fi
            echo "✅ Found: $doc"
          done

      - name: Check for Korean translations
        run: |
          if [ -f "README.md" ] && [ -f "README.ko.md" ]; then
            echo "✅ Korean translation exists"
          else
            echo "⚠️  Korean translation might be missing"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  all-checks-passed:
    name: All Checks Passed
    needs: [validate, shellcheck, yaml-lint, test-setup, documentation, security-scan]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.validate.result }}" == "success" ] && \
             [ "${{ needs.shellcheck.result }}" == "success" ] && \
             [ "${{ needs.yaml-lint.result }}" == "success" ] && \
             [ "${{ needs.test-setup.result }}" == "success" ] && \
             [ "${{ needs.documentation.result }}" == "success" ] && \
             [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "✅ All checks passed!"
            exit 0
          else
            echo "❌ Some checks failed"
            exit 1
          fi
