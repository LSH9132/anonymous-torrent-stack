name: Release

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v2.1.3 ë“±

permissions:
  contents: write
  discussions: write

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Extract changelog
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # CHANGELOG.mdì—ì„œ í˜„ì¬ ë²„ì „ì˜ ë‚´ìš© ì¶”ì¶œ
          awk -v ver="$VERSION" '
            /^## \['"$VERSION"'\]/ { flag=1; next }
            /^## \[/ { flag=0 }
            flag && NF { print }
          ' CHANGELOG.md > release_notes.md

          # ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
          if [ ! -s release_notes.md ]; then
            echo "Release v$VERSION" > release_notes.md
            echo "" >> release_notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release_notes.md
          fi

          cat release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create discussion for release
        uses: abirismyname/create-discussion@v1.2.0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          title: "Release v${{ steps.version.outputs.version }} ğŸ‰"
          body: |
            A new version has been released!

            See the [release notes](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}) for details.

            ---

            ìƒˆ ë²„ì „ì´ ë¦´ë¦¬ì¦ˆë˜ì—ˆìŠµë‹ˆë‹¤!

            ìì„¸í•œ ë‚´ìš©ì€ [ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }})ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.
          repository-id: ${{ secrets.REPOSITORY_ID }}
          category-id: ${{ secrets.ANNOUNCEMENTS_CATEGORY_ID }}
